---
- name: Setup dotfiles
  hosts: default
  tasks:
    - name: Install packages with apt
      become: yes
      ansible.builtin.apt:
        name:
          - bat
          - i3
          - kitty
          - stow
          - tmux
          - zsh
        state: present

    - name: Install packages with snap
      become: yes
      community.general.snap:
        name:
          - nvim
        state: present
        classic: true

    - name: Run Oh My Zsh installation script
      shell: |
        if [ ! -d "/home/{{ ansible_user_id }}/.oh-my-zsh" ]; then
          sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
        fi
      become: no
      environment:
        ZSH: "/home/{{ ansible_user_id }}/.oh-my-zsh"

    - name: Remove files that will conflict with Stow
      loop:
        - .zshrc
        - .tmux.conf
      ansible.builtin.file:
        path: "{{ ansible_env.HOME }}/{{ item }}"
        state: absent

    - name: Run stow
      shell: "stow . --target {{ ansible_env.HOME }} --verbose=2"
      register: result
      changed_when: "'LINK: ' in result.stderr"
